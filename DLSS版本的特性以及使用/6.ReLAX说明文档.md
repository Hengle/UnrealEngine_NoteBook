![NVIDIA Logo](../Images/nv-logo.png)

RTX Direct Illumination and NVIDIA Real-Time Denoiser (ReLAX)
=============================================================
*与技巧和技巧的最佳实践*

# 总结

你是否曾纠结于在Unreal中管理阴影投射灯的数量性能目标?调整灯的数量可能是一项乏味的任务，更加困难光线跟踪的上下文，其中每个光都有一个额外的属性，即是否投射光线跟踪阴影。

新的nvidia策划的RTXDI技术用于在NvRTX分支中采样阴影光解决方案，大大降低额外的阴影灯的成本。RTXDI通过选择，在每像素的基础上，哪些灯需要评估，然后发送所有照明的信号通过一个去噪器。通过只有一个光照通道和一个去噪通道，1盏灯和1000盏灯之间的成本差异几乎不存在。RTXDI技术集成到这个分支的是RTXDI SDK的派生。它刚刚调整并适应了UE4。

重要的是要注意，这里的RTXDI支持仍应被视为beta版本目前正在对其他场景进行测试。你可以期待它继续改善在接下来的几周。此外，值得注意的是RTXDI可能不是所有解决方案的最佳方案
照明场景。RTXDI在选择要处理和维护的灯时支付固定数额的开销时间的历史。在简单的照明场景中，比如只有一个方向光，`RTXDI可以比使用光线跟踪阴影的标准渲染管道更昂贵`。然而，它可能会产生效果更好的半影通过使用这个时间历史。RTXDI在三个方面真正出类拔萃。首先，它稳健地处理了大量的区域灯，而没有线性成本缩放在标准照明下。其次，它提供了一致的性能，在照明性能不会在某些地点方产生阻碍。最后，它提供了控制成本与质量的比例，所以你可以有一个质量滑块来权衡性能与图像的噪声或柔软度。


# 启用和使用RTXDI增强功能

首先，您需要在项目中启用光线跟踪，并使用D3D12 RHI运行。第二,你应该启用分支中包含的NRD去噪插件，因为这提供了单通道RTXDI所依赖的降噪器。出于简单的实验目的，你可以不去噪就运行它，但是对于最终结果，你显然需要去噪。(如果启用失败，RTXDI路径将发出警告接下来，只需通过切换控制台变量启用RTXDI代码`r.raytracing . sampleddirectlighting`设为1。现在，所有的阴影灯将利用采样照明系统。你可能会注意到一个快速闪烁，因为系统依赖于时间反馈。

默认情况下，所有投射阴影的灯光都将使用RTXDI，因为最有效的解决方案是使用每件事都用这一招。然而，该实现允许在灯光方面有很大的灵活性由RTXDI处理，并由UE4的标准着色通道处理。最常见的情况是否会排除方向光，如太阳，因为它们会影响帧中的所有像素经常主宰整个照明。可以通过两种机制从RTXDI中排除灯光。首先,灯有一个新的属性“支持采样照明”，以使它们能够参与RTXDI。第二,
几种类型的灯可以通过cvars控制。

## 灯光类别控制

`r.RayTracing.SampledLighting.Light.Point`
`r.RayTracing.SampledLighting.Light.Directional`
`r.RayTracing.SampledLighting.Light.Spot`
`r.RayTracing.SampledLighting.Light.Rect`

所有操作都像预期的那样，能够启用或禁用对给定的应用RTXDI光的类型。所有这些cvars默认为启用，并且它们在逻辑上与per light控件并置。

`r.RayTracing.SampledLighting.Light.FunctionLights`

RTXDI除了可以控制标准的灯光类型外，还可以排除所有的灯光功能灯。RTXDI支持光函数，但处理它们与光线跟踪着色器的区别可能使它们看起来略有不同或更多的别名，由于与评估光线功能在光线追踪着色器而不是像素着色器。

`r.RayTracing.SampledLighting.Lights.Particle` [0/1/2]

UE4将来自粒子系统的光视为一种特殊的“简单”类型，功能有限，包括没有阴影。RTXDI处理大量带有阴影的灯光的能力允许这种限制启用RTXDI时被解除。当设置为0(默认值)时，粒子灯的行为就像他们在基本UE4中那样他们不参与RTXDI。当cvar设置为1时，任何Niagara粒子都会使用新属性“Cast sampling Light Shadows”设置为true将通过RTXDI投射阴影来渲染。最后,将cvar设置为2将强制所有简单的灯光投射阴影，包括那些由Cascade产生的粒子系统。

`r.RayTracing.SampledLighting.Lights.Sky`

除标准灯外，RTXDI还可以评估skylight actor的漫反射成分。这可以以较低的成本产生类似UE4中光线跟踪skylight效果的效果。重要的是,这只覆盖skylight的漫反射方面，因为镜面组件是由其他通道处理的如射线跟踪反射或反射环境应用。此cvar默认为off以保持一致具有光线跟踪skylight功能。目前，它可能会显示出比光线跟踪skylight更多的噪音;然而，工作仍在进行中，光线追踪skylight使用了更多的样本来实现其结果。

RTXDI存在几个质量旋钮。目前最简单的调整质量的方法是使用`r.RayTracing.SampledLighting.Preset`命令。“预设”应用标准预设的质量等级之一。我们目前提供“中等”、“高”和“超”设置。这些设置与RTXDI SDK使用的设置非常相似样例，所以熟悉它的人可以直接映射设置。重要的是，设置
预设命令的影响也可以独立配置。

## 通过Preset配置的选项

`r.RayTracing.SampledLighting.Spatial.ApplyApproxVisibility`   [0/1]

`r.RayTracing.SampledLighting.Temporal.ApplyApproxVisibility`  [0/1]

它们一起控制收集光样本的偏置校正模式。使近似可见在应用重采样时，使用光线追踪检查候选光样本是否在阴影中。的时间和空间重采样通道提供了独立的控制，但在几乎所有情况下，权利解决方法是将它们设置为相同的值。启用这些将减少图像中的偏差。特别是它可以减少与地面真相相比，使场景变暗的偏见，因为它更准确拒绝遮挡光线。这些默认关闭在中等质量，但在高和超质量。

`r.RayTracing.SampledLighting.InitialSamples`  [1-N]

这是在开始采样照明通道时，每个像素测试的光的数量。测试得越多，所选光的质量越高。每测试一盏灯都需要额外的评估成本，因此较少初始样本意味着更好的性能。Medium和high默认值都是4,ultra默认值是8。

`r.RayTracing.SampledLighting.Spatial.Samples`  [1-16]

这是在应用空间重采样以试图找到更高质量的光样本时测试的样本数量。采取的越多，估计的质量越高，采取的越多，执行成本越高。目前样本的数量限制在最多16个。对于预设，中等和高都使用just
一个空间样本，ultra使用4个。

`r.RayTracing.SampledLighting.Spatial.SamplesBoost`  [1-16]

这是当一个像素确定它有糟糕的时间历史时需要测试的空间样本数量。之类的事件由于去遮挡而刚刚变得可见的对象被这个属性覆盖。它更有利于信号快速收敛到好的结果，以避免像去遮挡后的噪声痕迹这样的问题。默认的对于中等质量是8，高和超使用最大16。

## 其他质量选项

除了这些用于调整绑定到预设参数的质量的基本设置外，还有一些其他值得注意的设置。

`r.RayTracing.SampledLighting.BoilingFilterStrength`  [0.0 ... 1.0]

沸腾滤镜有助于避免异常样本试图接管图像。当这种情况发生时，工件通常看起来像一个奇怪的高光，它会覆盖屏幕的大部分。沸腾过滤器通过杀死统计上不正常的样本来解决这个问题。在测试中，0.35的过滤强度表现良好。较低的值可以提高样品的质量，因为它不会错误地丢弃实际上可能是好的样品，但会增加样品失控的风险。这里的值范围在0.0到1.0之间，期望的理想值范围在0.2到0.35之间。除非遇到问题，否则强烈建议不要更改默认值。

`r.RayTracing.SampledLighting.NumReservoirs`  [-1/1-N]

整个RTXDI算法依赖于跟踪一组光样本及其概率。这些组合的数量被称为存储库，它们是按时间历史的`每个像素`进行维护的。拥有更多的蓄水池可以降低信号中的噪声并提高信号质量，但显然，每增加一个蓄水池都会增加大量的成本。通常情况下，每个像素一个存储库可以产生良好的质量;然而，我们也见过在某些情况下，第二个储层的额外稳定性是有用的。在DLSS或TAAU等降低分辨率的升级渲染中，稳定性会受到一定影响，这一点最为明显。这很容易理解，因为RTXDI减少了照明样本的数量，DLSS减少了渲染样本的数量。为了简化操作，我们添加了默认的自动选择模式-1。当将水库数量设置为-1时，将根据图像缩放来选择水库数量。在使用大量的存储器时应该小心，因为在以1080p渲染时，每个额外的存储器都会消耗大约64 MB的显存。

`r.RayTracing.SampledLighting.MinReservoirs`  [1-N]

这是使用自动选择来确定储层数量时所选择的最小储层数量。它表示在没有应用DLSS等重新缩放时将使用的数字。

`r.RayTracing.SampledLighting.MaxReservoirs`  [1-N]

这是自动选择确定油藏数量时所选择的最大油藏数量。它表示在应用DLSS等重新缩放时将使用的数字。

`r.RayTracing.SampledLighting.InitialSamplesBoost`  [1-N]

当历史记录被外部事件清除时，此值会导致额外的初始样本。这种情况只会发生在镜头切割时，所以这个选项不太可能需要重大影响。

`r.RayTracing.SampledLighting.TestInitialVisibility` [0/1/2]

这控制在执行的初始采样阶段是否发射遮挡射线。零表示不进行可见性测试，所选光被向前传递到其他相位，即使它在样本位置可能不可见。这是一个更便宜的选择，但图像收敛可能更慢。设置为1意味着对最终选择的光样本进行可见性测试。这种模式收敛得更快，但在某些条件下，大量的原始样本可能会产生比预期更亮的结果。经典的例子是在强定向光的阴影下，新去除遮挡的样本。方案2成本最高，因为它需要测试每种储层类型(局部、定向等)的可视性，以减少这些误差。

`r.RayTracing.SampledLighting.EnableHairVoxel` [0/1]

是否检查毛发体素在RTXDI处理的表面上的阴影贡献。

## 基于头发的支持

`r.RayTracing.SampledLighting.Hair` [0/1]

这将启用/禁用对基于头发的RTXDI渲染的支持。由于在gbuffer中不存在基于束的毛发，它必须通过单独的照明通道被点亮。这个光照通道不能像标准RTXDI那样利用历史和去噪，因为它不存在于gbuffer中。因此，它的工作方式就像RTXDI一样，只是一个初始样本传递。

`r.RayTracing.SampledLighting.Hair.Samples` [1-N]
 
为头发照明评估每个头发样本的相似样本数量。更多的样品可以减少噪音，提高头发质量。
 
 `r.RayTracing.SampledLighting.Hair.Candidates` [1-N]
 
候选样本的数量，以生成用于遮光头发的每个样本。

## 其他选项

还有一些额外的高级调试和调优选项可用，但绝大多数用户都不会关心它们。对于试图理解任何可能主要的用户来说，一个方便的选项是禁用去噪器的能力。

`r.RayTracing.SampledLighting.Denoiser`  [0/2]

将此控制台变量设置为0将显示不应用去噪的RTXDI结果。这有助于理解`伪影`是来自RTXDI中的光照，还是去噪通道的结果。去噪器的默认值是2，这意味着使用NRD插件中的ReLAX去噪器。为了匹配争用，1打算使用UE4内置的去噪器;然而，目前还没有这样的实现。

# NVIDIA Real-time Denoiser using ReLAX

[Full NRD Plug-in Readme](../../Engine/Plugins/Runtime/Nvidia/NRD/README.md) 

像大多数光线追踪效果一样，RTXDI依赖于去噪来产生干净的图像。集成到NvRTX的解决方案是来自NVIDIA“NRD”实时降噪器SDK的ReLAX降噪器。它像其他UE4去噪器一样使用去噪器插件接口，因此希望使用它的项目需要启用该插件。与UE4中的其他降噪系统不同，这个特殊的系统没有工作内置的回退，所以它要么使用插件，要么完全放弃去噪。

ReLAX包含大量的可调选项，默认值对于大多数用户来说应该是合理的。几乎所有相关的控制台变量都属于名称空间`r.NRD.ReLAX`，让他们很容易被找到。有一个选择( `r.NRD.DenoisingRange` )，它可能经常在项目之间进行调整，因为它与世界的规模有关。去噪范围用于限制去噪器的应用范围，以便它不是在处理天空像素。缺省值为10万单位，按照标准约定为1公里。大型户外环境可能需要提高这一限制。任何超出限制的东西不仅会失去去噪，而且不会接收RTXDI的光照。

另一个可能值得调优的方面是时间响应性。UE4中的集成具有针对响应性优化的默认设置。在我们的测试中，这似乎是避免在快速移动的阴影上重影的最佳配置。对响应性的偏向可能会降低图像的时间稳定性，就像阴影中一个薄特征上的闪烁一样。虽然我们还没有观察到这种情况的任何重大发生，但在理论上是可能的。调整ReLAX参数`r.NRD.Relax.History.DiffuseFastMaxAccumulatedFrameNum`是在我们的实验中调整这些行为的最有效的方法。默认值为0将提供最灵敏的信号，而将其增加到4这样的值可能会最大限度地提高时间稳定性。

# 一般项

RTXDI源自一种名为[ReSTIRS](https://developer.nvidia.com/blog/rendering-millions-of-dynamics-lights-in-realtime/)的算法。它的工作原理是统计地选择每像素渲染的灯光，并保存所选灯光重要性的时间历史。它首先随机选择少量初始候选样本，并根据它们可能的贡献计算权重。最终，从一堆样本中选择一个样本，然后与上一帧的样本进行比较。接下来，像素搜索附近的几个像素，寻找更好的样本。每一步都会提高所选样本的质量，通过将时间历史从一帧输入到下一帧，质量会继续提高。一旦选择了光样本，就会投射阴影射线并执行阴影。这将产生一个包含去噪器ReLAX处理的噪声图像，以产生代表所有采样光的最终阴影结果。
